<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Product QR</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/qr_pages.css') }}">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript" crossorigin="anonymous"></script>
</head>

<body>

    <div class="container">
        <div class="premium-card">
            <h2>Scan QR Code</h2>
            <p class="subtitle">Focus the QR code within the frame</p>

            <div id="reader"></div>

            <div id="result-container" class="product-details">
                <h3>Product Details</h3>
                <div id="result-content">
                    <!-- Data will be injected here -->
                </div>
                <button onclick="restartScanner()"
                    style="background: rgba(255,255,255,0.1); color: var(--text-muted); margin-top: 1.5rem;">Scan
                    Another</button>
            </div>

            <div id="loading" style="display:none; color: var(--text-muted); margin-top: 1rem;">
                Searching for product...
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {{ firebase_config | tojson }};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let html5QrCode;
        const scannerConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);

            await html5QrCode.stop();

            document.getElementById("loading").style.display = "block";
            document.getElementById("reader").style.display = "none";

            let productId = decodedText;
            let storeId = null;

            // Try to parse JSON (Standard in the new system)
            try {
                const json = JSON.parse(decodedText);
                if (json.id) {
                    productId = json.id;
                    storeId = json.store_id || null;
                }
            } catch (e) {
                // Not JSON, assume plain ID
            }

            // Determine Firebase Path
            const dbPath = storeId ? `stores/${storeId}/products/${productId}` : `products/${productId}`;

            // Fetch from Firebase
            database.ref(dbPath).once("value")
                .then((snapshot) => {
                    const data = snapshot.val();
                    document.getElementById("loading").style.display = "none";

                    if (data) {
                        const resultContainer = document.getElementById("result-container");
                        resultContainer.style.display = "block";
                        resultContainer.classList.add("active");

                        const stockStatus = parseInt(data.stock) > 0 ?
                            `<span style="color: #10b981; font-weight: 600;">‚óè In Stock (${data.stock})</span>` :
                            `<span style="color: #ef4444; font-weight: 600;">‚óè Out of Stock</span>`;

                        document.getElementById("result-content").innerHTML = `
                            ${data.image ? `<img src="${data.image}" style="width: 100%; height: 200px; object-fit: contain; background: #fff; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">` : ''}
                            
                            <div style="text-align: left; margin-bottom: 1.5rem;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.2rem;">${data.brand || 'Generic'}</div>
                                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">${data.name || 'Unknown Product'}</h2>
                                <div style="font-size: 1.8rem; font-weight: 800; color: var(--accent); margin: 0.5rem 0;">‚Çπ${data.price || '0'}</div>
                                ${stockStatus}
                            </div>

                            <div style="background: rgba(255,255,255,0.05); padding: 1.2rem; border-radius: 12px; text-align: left; margin-bottom: 1rem;">
                                <div class="detail-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.8rem; margin-bottom: 0.8rem;">
                                    <div class="detail-label" style="font-size: 0.75rem; color: var(--text-muted);">CATEGORY</div>
                                    <div class="detail-value" style="font-weight: 600;">${data.category || 'General'}</div>
                                </div>
                                <div class="detail-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.8rem; margin-bottom: 0.8rem;">
                                    <div class="detail-label" style="font-size: 0.75rem; color: var(--text-muted);">DESCRIPTION</div>
                                    <div class="detail-value" style="font-weight: 400; line-height: 1.4;">${data.description || 'No description available.'}</div>
                                </div>
                                ${data.specs ? `
                                <div class="detail-item">
                                    <div class="detail-label" style="font-size: 0.75rem; color: var(--text-muted);">SPECIFICATIONS</div>
                                    <div class="detail-value" style="font-weight: 400; font-size: 0.85rem; white-space: pre-line; line-height: 1.5;">${data.specs}</div>
                                </div>` : ''}
                            </div>

                            <button onclick="addToCart('${productId}', '${storeId}')" style="width: 100%; padding: 1rem; background: var(--accent); border-radius: 10px; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; cursor: pointer;">Add to Cart</button>
                        `;

                        if (window.navigator.vibrate) window.navigator.vibrate(100);
                    } else {
                        alert("Product not found!");
                        restartScanner();
                    }
                }).catch(err => {
                    console.error(err);
                    alert("Error fetching product details");
                    restartScanner();
                });
        }

        async function addToCart(productId, storeId) {
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: productId, store_id: storeId, quantity: 1 })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Added to cart!");
                } else {
                    alert("Error: " + result.error);
                }
            } catch (err) {
                console.error(err);
                alert("Failed to add to cart");
            }
        }

        function restartScanner() {
            document.getElementById("result-container").style.display = "none";
            document.getElementById("reader").style.display = "block";
            startScanner();
        }

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                scannerConfig,
                onScanSuccess
            ).catch(err => {
                console.error("Scanner failed to start", err);
                // Fallback for desktop or non-back camera
                html5QrCode.start(
                    { facingMode: "user" },
                    scannerConfig,
                    onScanSuccess
                );
            });
        }

        // Start on load
        window.addEventListener('load', startScanner);
    </script>

</body>

</html>